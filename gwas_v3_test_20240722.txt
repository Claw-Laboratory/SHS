#Filtering vcf file by sample IDs	
# Define input and output directories
input_dir="/data/SHSusers/MEGA/MEGA/MEGAimpute/for_epacts"
output_dir="vcf/"
sample_file="SHSph2_sample_ID_list_20240722CAS_no_space.txt"

# Loop over chromosomes
for i in {1..22}; do
  echo "Processing chromosome ${i}..."

  # Input and output file paths
  input_file="${input_dir}/chr${i}/chr${i}.filtered.epacts.vcf.gz"
  output_file="${output_dir}/chr${i}_ph2_filtered.vcf"

  # Check if input file exists
  if [ ! -f "${input_file}" ]; then
    echo "Input file ${input_file} does not exist. Skipping chromosome ${i}."
    continue
  fi

  # Ensure output directory exists
  mkdir -p "${output_dir}"

  # Filter the VCF file
  bcftools view -S "${sample_file}" -Oz -o "${output_file}" "${input_file}" --force-samples

  echo "Completed chromosome ${i}."
done

#converting vcf to plink format
#plink --vcf chr19_ph2_filtered.vcf --make-bed --out chr19_ph2
for i in {1..22}; do
  plink --vcf chr${i}_ph2_filtered.vcf.gz --make-bed --out chr${i}_ph2
done

#QC has been performed on data

# Create script to run GWAS 
	#plink --bfile chr19_ph2_9 --linear --pheno cleaned_phenotypes.txt --pheno-name logNMR --allow-no-sex --out 
	
#!/bin/bash

# Create the script to run GWAS on a single chromosome
echo '#!/bin/bash
chromosome=$1
echo "Running GWAS for chromosome ${chromosome}"
plink --bfile chr${chromosome} --linear --pheno SHSph2_phenotypes_clean20240722CAS_NA_RM.csv --pheno-name logNMR --covar SHSph2_covariates_clean20240722CAS.csv --out gwas_results_chr${chromosome}
echo "GWAS for chromosome ${chromosome} completed"' > run_gwas.sh

chmod +x run_gwas.sh

# Run GWAS in parallel for all chromosomes
parallel ./run_gwas.sh ::: {1..22}

# Combine results
# Create header
head -n 1 gwas_results_chr1.assoc > gwas_combined_results.assoc

# Append results
for i in {1..22}; do
  tail -n +2 gwas_results_chr${i}.assoc >> gwas_combined_results.assoc
done

#Bonferoni correction
awk 'NR==1 || $9 < 0.00000005' gwas_combined_results.assoc > gwas_combined_results_sig_20240722.txt
